# Database Package

Shared database package for the social media application using Drizzle ORM and PostgreSQL.

## Table of Contents

- [ID Strategy](#id-strategy)
- [Database Architecture](#database-architecture)
- [Schema Design Patterns](#schema-design-patterns)
- [Installation](#installation)
- [Usage](#usage)
- [Migrations](#migrations)

---

## ID Strategy

### Snowflake IDs

We use **Snowflake IDs** (invented by Twitter) for all primary keys. These are 64-bit integers that encode:
- **Timestamp** (41 bits): Milliseconds since custom epoch (2024-01-01)
- **Worker ID** (5 bits): Server instance identifier (0-31)
- **Sequence** (12 bits): Per-millisecond counter (0-4095)

**Example:** `175928847299117063`

### Why Snowflake IDs?

1. ✅ **Time-ordered** - Sortable by creation time
2. ✅ **Distributed** - No coordination needed between servers
3. ✅ **Compact** - 8 bytes (vs 16 bytes for UUID)
4. ✅ **Sharding-ready** - Designed for future database sharding
5. ✅ **Decentralized** - Generated by application servers, not database

### Storage Strategy: BIGINT in Database, String in Code

**Database Layer:**
```sql
-- Stored as BIGINT (8 bytes - efficient storage and indexing)
CREATE TABLE users (
  id BIGINT PRIMARY KEY
);
```

**Application Layer:**
```typescript
// Handled as string (JSON-compatible, no precision loss)
const userId = generateSnowflakeId(); // "175928847299117063"
```

**Why this approach?**
- ✅ **Efficient storage**: 8 bytes in database (vs 20+ bytes for VARCHAR)
- ✅ **Fast indexing**: BIGINT indexes are faster than VARCHAR
- ✅ **JSON compatible**: Strings work with JSON.stringify()
- ✅ **Frontend safe**: No precision loss in JavaScript (which only supports 53-bit integers)
- ✅ **Industry standard**: Used by Discord, Twitter, Instagram

**Custom Drizzle Type:**

We use a custom Drizzle type that stores as BIGINT but handles as string:

```typescript
// packages/database/src/utils/snowflake-column.ts
export const snowflakeId = customType<{ data: string; driverData: string }>({
  dataType() {
    return 'bigint';
  },
  toDriver(value: string): string {
    return value;
  },
  fromDriver(value: string): string {
    return value;
  },
});
```

**Schema definition:**
```typescript
id: snowflakeId('id')
  .primaryKey()
  .$defaultFn(() => generateSnowflakeId())
// TypeScript type: string
// Database type: BIGINT
```

---

## Database Architecture

### Shared Database: `social_media_db`

The following tables are in the **shared database** used by multiple services:

| Table | Description | Service Usage |
|-------|-------------|---------------|
| `users` | User accounts and profiles | All services |
| `posts` | User posts/content | Posts service, Feed service |
| `comments` | Comments on posts | Posts service, Comments service |
| `likes` | Likes on posts | Posts service, Engagement service |

**Location:** `packages/database/src/schema/`

### Service-Specific Databases

Some tables belong to specific services and will be moved to their own databases:

#### Hashtag Service
- `hashtags` - Hashtag definitions and usage counts
- `posts_hashtags` - Many-to-many relationship between posts and hashtags

**Future location:** `apps/hashtag-service/db/`

**Rationale:** Hashtags are global data (not sharded by user), require different scaling strategy, and have different access patterns.

---

## Schema Design Patterns

### 1. Snowflake IDs for Primary Keys
```typescript
id: bigint('id', { mode: 'string' })
  .primaryKey()
  .$defaultFn(() => generateSnowflakeId())
```

### 2. Soft Deletes
```typescript
deletedAt: timestamp('deleted_at')
```
Posts use soft deletes to preserve data integrity and allow recovery.

### 3. Denormalized Counts
```typescript
likesCount: integer('likes_count').default(0).notNull()
commentsCount: integer('comments_count').default(0).notNull()
```
Performance optimization - avoid COUNT queries on large tables.

### 4. Proper Indexing
```typescript
(t) => ({
  userIdIdx: index('posts_user_id_idx').on(t.userId),
  createdAtIdx: index('posts_created_at_idx').on(t.createdAt),
})
```

### 5. Unique Constraints
```typescript
(t) => ({
  userPostUnique: unique('likes_user_post_unique').on(t.userId, t.postId),
})
```

---

## Installation

```bash
# Install dependencies
npm install

# Start PostgreSQL (Docker)
docker-compose up -d postgres
```

---

## Usage

### Generate Snowflake ID
```typescript
import { generateSnowflakeId } from '@repo/database/utils/snowflake';

const userId = generateSnowflakeId();
// => "175928847299117063"
```

### Query Database
```typescript
import { db } from '@repo/database';
import { users } from '@repo/database/schema';
import { eq } from 'drizzle-orm';

// Find user by ID
const user = await db.query.users.findFirst({
  where: eq(users.id, userId)
});
```

---

## Migrations

### Generate Migration
```bash
npm run db:generate --workspace=@repo/database
```

### Run Migrations
```bash
npm run db:migrate --workspace=@repo/database
```

### Push Schema (Development)
```bash
npm run db:push --workspace=@repo/database
```

### Drizzle Studio (GUI)
```bash
npm run db:studio --workspace=@repo/database
```

